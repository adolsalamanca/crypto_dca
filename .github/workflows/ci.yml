name: Monthly BTC Buy

on:
  schedule:
    # Run on the 9th of every month at 08:00 UTC
    # This corresponds to 09:00 Europe/Madrid in winter (CET = UTC+1)
    # In summer (CEST = UTC+2), this will run at 10:00 Madrid time
    # See README for DST considerations
    - cron: '0 8 9 * *'

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual order)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  buy:
    runs-on: self-hosted
    env:
      DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Run DCA Bot
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_API_SECRET: ${{ secrets.BINANCE_API_SECRET }}
        run: |
          uv run python -m src.main \
            --symbol "${{ vars.SYMBOL || 'BTCEUR' }}" \
            --spend-eur "${{ secrets.SPEND_EUR || '50' }}" \
            --price-multiplier "${{ vars.PRICE_MULTIPLIER || '0.999' }}" \
            --time-in-force "${{ vars.TIME_IN_FORCE || 'GTC' }}" \
            --base-url "${{ vars.BINANCE_BASE_URL || 'https://api.binance.com' }}" \
            --log-level "${{ vars.LOG_LEVEL || 'INFO' }}" \
            ${{ env.DRY_RUN == 'true' && '--dry-run' || '' }}
