name: Run Database Migrations

on:
  # Allow manual trigger
  workflow_dispatch:

jobs:
  migrate:
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install migrate tool
        run: |
          if ! command -v migrate &> /dev/null; then
            echo "Installing golang-migrate..."
            curl -L https://github.com/golang-migrate/migrate/releases/download/v4.18.1/migrate.linux-amd64.tar.gz | tar xvz
            sudo mv migrate /usr/local/bin/migrate
            sudo chmod +x /usr/local/bin/migrate
          fi
          migrate -version

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "Error: DATABASE_URL secret is not set"
            exit 1
          fi

          echo "Running all pending migrations..."
          migrate -path migrations -database "$DATABASE_URL" up

      - name: Show migration status
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Current migration version:"
          migrate -path migrations -database "$DATABASE_URL" version
